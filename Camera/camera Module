import carla
import time
import random
import math
import os
import numpy as np
import pygame

OUTPUT_DIR = "output_rgb"
SAVE_EVERY_N_FRAMES = 10       # save every 5 frames (reduce disk load)
CAM_W, CAM_H = 640, 360        # smaller = faster (performance friendly)
CAM_FOV = 90

def main():
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    # ---- Connect ----
    client = carla.Client("localhost", 2000)
    client.set_timeout(10.0)
    world = client.get_world()
    bp_lib = world.get_blueprint_library()

    # ---- Spawn vehicle ----
    vehicle_bp = bp_lib.find("vehicle.tesla.model3")
    if vehicle_bp.has_attribute("color"):
        vehicle_bp.set_attribute(
            "color",
            random.choice(vehicle_bp.get_attribute("color").recommended_values)
        )

    spawn_points = world.get_map().get_spawn_points()
    random.shuffle(spawn_points)

    vehicle = None
    for sp in spawn_points[:40]:
        vehicle = world.try_spawn_actor(vehicle_bp, sp)
        if vehicle:
            break

    if vehicle is None:
        print("ERROR: Could not spawn vehicle. Stop traffic and try again.")
        return

    vehicle.set_autopilot(True)
    print("‚úÖ Vehicle spawned and autopilot enabled.")

    # ---- Spectator follows vehicle ----
    spectator = world.get_spectator()

    # ---- Create RGB camera sensor ----
    cam_bp = bp_lib.find("sensor.camera.rgb")
    cam_bp.set_attribute("image_size_x", str(CAM_W))
    cam_bp.set_attribute("image_size_y", str(CAM_H))
    cam_bp.set_attribute("fov", str(CAM_FOV))

    # Camera mounted on car (slightly forward + above windshield)
    cam_transform = carla.Transform(
        carla.Location(x=1.5, z=1.7),
        carla.Rotation(pitch=-10)
    )

    camera = world.spawn_actor(cam_bp, cam_transform, attach_to=vehicle)
    print("‚úÖ RGB camera attached.")

    # ---- Pygame display ----
    pygame.init()
    screen = pygame.display.set_mode((CAM_W, CAM_H))
    pygame.display.set_caption("CARLA RGB Camera (live) ‚Äî press ESC to quit")
    clock = pygame.time.Clock()

    latest_surface = None
    last_saved_frame = -1

    def on_image(image: carla.Image):
        nonlocal latest_surface, last_saved_frame

        # Convert BGRA raw bytes to RGB array
        array = np.frombuffer(image.raw_data, dtype=np.uint8)
        array = array.reshape((image.height, image.width, 4))
        rgb = array[:, :, :3][:, :, ::-1]  # BGRA -> RGB

        # Pygame expects (width, height, 3), so swap axes
        rgb = np.swapaxes(rgb, 0, 1)
        latest_surface = pygame.surfarray.make_surface(rgb)

        # Save to disk every N frames (prevents huge storage + lag)
        if image.frame % SAVE_EVERY_N_FRAMES == 0 and image.frame != last_saved_frame:
            filename = os.path.join(OUTPUT_DIR, f"{image.frame:06d}.png")
            image.save_to_disk(filename)
            last_saved_frame = image.frame

    camera.listen(on_image)

    print(f"üìÅ Saving images to: {os.path.abspath(OUTPUT_DIR)} (every {SAVE_EVERY_N_FRAMES} frames)")

    try:
        while True:
            # Handle window events
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    raise KeyboardInterrupt
                if event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE:
                    raise KeyboardInterrupt

            # Move spectator behind the car
            transform = vehicle.get_transform()
            loc = transform.location
            rot = transform.rotation
            yaw = math.radians(rot.yaw)

            cam_loc = loc + carla.Location(
                x=-8.0 * math.cos(yaw),
                y=-8.0 * math.sin(yaw),
                z=4.0
            )
            cam_rot = carla.Rotation(pitch=-15.0, yaw=rot.yaw, roll=0.0)
            spectator.set_transform(carla.Transform(cam_loc, cam_rot))

            # Draw latest camera frame
            if latest_surface is not None:
                screen.blit(latest_surface, (0, 0))
                pygame.display.flip()

            # Cap to ~30 FPS (helps performance)
            clock.tick(10)

    except KeyboardInterrupt:
        print("\nStopping...")

    finally:
        # Clean up
        try:
            camera.stop()
        except Exception:
            pass

        if camera is not None:
            camera.destroy()
        if vehicle is not None:
            vehicle.destroy()

        pygame.quit()
        print("‚úÖ Cleaned up (camera + vehicle destroyed). Done.")

if __name__ == "__main__":
    main()
