import carla
import time
import os

OUT_FILE = "camera_shot.png"
W, H = 640, 360
FOV = 90

def main():
    client = carla.Client("localhost", 2000)
    client.set_timeout(10.0)
    world = client.get_world()
    bp = world.get_blueprint_library()

    # --- Find an existing vehicle (your autopilot car) ---
    vehicles = world.get_actors().filter("vehicle.*")
    if len(vehicles) == 0:
        print("ERROR: No vehicle found in the world. Run your autopilot script first.")
        return

    # Pick the first vehicle found
    vehicle = vehicles[0]
    print(f"Using vehicle id={vehicle.id}, type={vehicle.type_id}")

    # --- Create RGB camera sensor ---
    cam_bp = bp.find("sensor.camera.rgb")
    cam_bp.set_attribute("image_size_x", str(W))
    cam_bp.set_attribute("image_size_y", str(H))
    cam_bp.set_attribute("fov", str(FOV))

    # Mount camera on the car (front, above hood)
    cam_tf = carla.Transform(
        carla.Location(x=1.5, z=1.7),
        carla.Rotation(pitch=-10)
    )

    camera = world.spawn_actor(cam_bp, cam_tf, attach_to=vehicle)
    print("✅ Camera attached. Waiting for 1 frame...")

    saved = {"done": False}

    def on_image(image):
        if not saved["done"]:
            image.save_to_disk(OUT_FILE)
            saved["done"] = True
            print(f"✅ Saved: {os.path.abspath(OUT_FILE)}")

    camera.listen(on_image)

    try:
        # wait up to 5 seconds for first frame
        t0 = time.time()
        while not saved["done"] and (time.time() - t0) < 5.0:
            time.sleep(0.05)

    finally:
        try:
            camera.stop()
        except Exception:
            pass
        camera.destroy()
        print("Camera destroyed. Done.")

if __name__ == "__main__":
    main()
